<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <div>
        <h1 class="header-title">üìã √âvaluations Trimestrielles</h1>
        <p class="header-subtitle">Bilan trimestriel des prestations de maintenance</p>
      </div>
      <button
        class="btn btn-primary"
        *ngIf="authService.isAdmin() || authService.isAgentDGSI()"
        (click)="showCreateForm = true"
      >
        ‚ûï Nouvelle √âvaluation
      </button>
    </div>
  </div>

  <!-- Evaluations List -->
  <div class="evaluations-list" *ngIf="!loading">
    <div
      class="evaluation-item"
      *ngFor="let evaluation of evaluations"
    >
      <div class="evaluation-info">
        <div class="evaluation-main">
          <h3 class="evaluation-title">{{ evaluation.prestataireNom }}</h3>
          <div class="evaluation-details">
            <span class="detail-item">üè¢ {{ evaluation.lot }}</span>
            <span class="detail-item">üìÖ {{ evaluation.trimestre }}</span>
            <span class="detail-item">üìä Note: {{ evaluation.noteFinale || 0 }}/8</span>
            <span class="detail-item">üìÖ {{ formatDate(evaluation.dateEvaluation) }}</span>
          </div>
        </div>
        <div class="evaluation-actions">
          <button
            class="btn btn-primary"
            (click)="viewReport(evaluation)"
          >
            üëÅÔ∏è Voir Rapport
          </button>
          <button
            class="btn btn-success"
            (click)="generatePdf(evaluation)"
          >
            üìÑ G√©n√©rer PDF
          </button>
        </div>
      </div>
    </div>

    <div class="no-data" *ngIf="evaluations.length === 0">
      <p>üì≠ Aucune √©valuation disponible</p>
      <p>Cr√©ez votre premi√®re √©valuation trimestrielle</p>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="loading">
    <p>‚è≥ Chargement des √©valuations...</p>
  </div>

  <!-- Create Evaluation Modal -->
  <div class="modal-overlay" *ngIf="showCreateForm" (click)="showCreateForm = false">
    <div class="modal-content form-modal" (click)="$event.stopPropagation()">
      <form [formGroup]="evaluationForm" (ngSubmit)="onSubmit()" class="evaluation-form">
        <h2 class="form-title">Cr√©er une √âvaluation Trimestrielle</h2>

        <div class="form-row">
          <div class="form-group">
            <label for="lot">Lot *</label>
            <input
              type="text"
              id="lot"
              formControlName="lot"
              placeholder="Ex: Lot A"
              class="line-input"
              [class.error]="evaluationForm.get('lot')?.invalid && evaluationForm.get('lot')?.touched"
            />
          </div>

          <div class="form-group">
            <label for="trimestre">Trimestre *</label>
            <select
              id="trimestre"
              formControlName="trimestre"
              class="line-input"
              [class.error]="evaluationForm.get('trimestre')?.invalid && evaluationForm.get('trimestre')?.touched"
            >
              <option value="">S√©lectionnez un trimestre</option>
              <option value="T1">T1 - Janvier √† Mars</option>
              <option value="T2">T2 - Avril √† Juin</option>
              <option value="T3">T3 - Juillet √† Septembre</option>
              <option value="T4">T4 - Octobre √† D√©cembre</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="dateEvaluation">Date d'√âvaluation *</label>
            <input
              type="date"
              id="dateEvaluation"
              formControlName="dateEvaluation"
              class="line-input"
              [class.error]="evaluationForm.get('dateEvaluation')?.invalid && evaluationForm.get('dateEvaluation')?.touched"
            />
          </div>

          <div class="form-group">
            <label for="prestataireNom">Prestataire *</label>
            <input
              type="text"
              id="prestataireNom"
              formControlName="prestataireNom"
              placeholder="Nom du prestataire"
              class="line-input"
              [class.error]="evaluationForm.get('prestataireNom')?.invalid && evaluationForm.get('prestataireNom')?.touched"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="evaluateurNom">√âvaluateur *</label>
            <input
              type="text"
              id="evaluateurNom"
              formControlName="evaluateurNom"
              placeholder="Nom de l'√©valuateur"
              class="line-input"
              [class.error]="evaluationForm.get('evaluateurNom')?.invalid && evaluationForm.get('evaluateurNom')?.touched"
            />
          </div>

          <div class="form-group">
            <label for="correspondantId">Agent DGSI *</label>
            <input
              type="number"
              id="correspondantId"
              formControlName="correspondantId"
              placeholder="ID de l'agent"
              class="line-input"
              [class.error]="evaluationForm.get('correspondantId')?.invalid && evaluationForm.get('correspondantId')?.touched"
            />
          </div>
        </div>

        <div class="criteria-section">
          <h3>Crit√®res d'√âvaluation</h3>
          <div class="criteria-grid">
            <div class="checkbox-group">
              <input type="checkbox" id="rapportInterventionTransmis" formControlName="rapportInterventionTransmis">
              <label for="rapportInterventionTransmis">Rapport d'intervention transmis</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="registreRempli" formControlName="registreRempli">
              <label for="registreRempli">Registre rempli</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="horairesRespectes" formControlName="horairesRespectes">
              <label for="horairesRespectes">Horaires respect√©s</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="delaiReactionRespecte" formControlName="delaiReactionRespecte">
              <label for="delaiReactionRespecte">D√©lai de r√©action respect√© (4h)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="delaiInterventionRespecte" formControlName="delaiInterventionRespecte">
              <label for="delaiInterventionRespecte">D√©lai d'intervention respect√© (24h)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="vehiculeDisponible" formControlName="vehiculeDisponible">
              <label for="vehiculeDisponible">V√©hicule disponible</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="tenueDisponible" formControlName="tenueDisponible">
              <label for="tenueDisponible">Tenue r√©glementaire disponible</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="techniciensCertifies" formControlName="techniciensCertifies">
              <label for="techniciensCertifies">Techniciens certifi√©s ITIL</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="observationsGenerales">Observations G√©n√©rales</label>
          <textarea
            id="observationsGenerales"
            formControlName="observationsGenerales"
            rows="3"
            placeholder="Observations g√©n√©rales sur la p√©riode..."
            class="line-input"
          ></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="showCreateForm = false">
            Annuler
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="evaluationForm.invalid || loading">
            {{ loading ? 'Cr√©ation...' : 'Cr√©er l\'√âvaluation' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Report Modal -->
  <div class="modal-overlay" *ngIf="showReportModal" (click)="closeReportModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <app-evaluation-report
        *ngIf="selectedEvaluation"
        [evaluation]="selectedEvaluation"
      ></app-evaluation-report>
      <div style="padding: 1rem; text-align: center;">
        <button class="btn btn-secondary" (click)="closeReportModal()">
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>